<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ninky</title>
    
    <!-- PWA ãƒ¡ã‚¿ã‚¿ã‚° -->
    <meta name="description" content="ä»»æœŸç®¡ç†ã‚’è‡ªå‹•åŒ–ï¼ãƒ—ãƒ­ã®ãŸã‚ã®å½¹å“¡ç®¡ç†ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‚">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ninky">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ -->
    <link rel="manifest" href="./ninky-manifest.json">
    
    <!-- PWA ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆiOSå¯¾å¿œãƒ»æ­£å¼ã‚¢ã‚¤ã‚³ãƒ³çµ±ä¸€ï¼‰ -->
    <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .edit-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 6px 12px;
            font-size: 0.9rem;
            margin-right: 5px;
        }

        .officer-list {
            margin-top: 20px;
        }

        .officer-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .officer-info {
            flex-grow: 1;
        }

        .officer-info strong {
            color: #333;
            font-size: 1.1rem;
        }

        .officer-details {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .expiry-date {
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 5px;
            margin-left: 15px;
        }

        .expiry-soon {
            background-color: #ffebee;
            color: #c62828;
        }

        .expiry-normal {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .expiry-expired {
            background-color: #ffcdd2;
            color: #d32f2f;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .notification-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .notification-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 10px;
        }

        .notification-item {
            padding: 5px 0;
            border-bottom: 1px solid #f0e68c;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .month-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .month-header {
            background: #667eea;
            color: white;
            padding: 15px;
            font-weight: bold;
        }

        .month-content {
            padding: 15px;
        }

        .company-expiry {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .export-section {
            text-align: center;
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .month-grid {
                grid-template-columns: 1fr;
            }
            
            .officer-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
        
        /* å¸æ³•æ›¸å£«å®Ÿå‹™æœ€é©åŒ–: è¦–èªæ€§å‘ä¸ŠCSS */
        
        /* æº€äº†äºˆå®š/æº€äº†æ¸ˆã¿ãƒ–ãƒ­ãƒƒã‚¯è¡¨ç¤º */
        .expiry-block {
            margin-bottom: 20px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .upcoming-block {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
            border-color: #4caf50;
        }
        
        .expired-block {
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            border-color: #bdbdbd;
        }
        
        .block-title {
            background: rgba(0, 0, 0, 0.05);
            margin: 0;
            padding: 12px 16px;
            font-weight: bold;
            font-size: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .upcoming-block .block-title {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
        }
        
        .expired-block .block-title {
            background: linear-gradient(135deg, #757575, #9e9e9e);
            color: white;
        }
        
        .officer-items {
            padding: 16px;
        }
        
        .expired-item {
            opacity: 0.8;
        }
        
        .expiry-critical {
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: white;
            font-weight: bold;
        }
        
        /* å¹´ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤º */
        .year-frame {
            margin-bottom: 24px;
            border: 2px solid #667eea;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        }
        
        .year-title {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 16px 20px;
            font-size: 18px;
            font-weight: bold;
            margin: 0;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        
        .month-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .month-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .month-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 16px;
            font-weight: bold;
            text-align: center;
        }
        
        .company-expiry {
            padding: 12px;
            border-bottom: 1px solid #f5f5f5;
            line-height: 1.4;
        }
        
        .company-expiry:last-child {
            border-bottom: none;
        }
        
        /* æœˆåˆ¥ä¸€è¦§ã®ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ */
        .company-expiry {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .company-info {
            flex: 1;
        }
        
        .month-actions {
            display: flex;
            gap: 8px;
            margin-left: 10px;
        }
        
        .month-actions .edit-btn,
        .month-actions .delete-btn {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .month-actions .edit-btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
        }
        
        .month-actions .edit-btn:hover {
            background: linear-gradient(135deg, #388e3c, #4caf50);
            transform: translateY(-1px);
        }
        
        .month-actions .delete-btn {
            background: linear-gradient(135deg, #f44336, #ef5350);
            color: white;
        }
        
        .month-actions .delete-btn:hover {
            background: linear-gradient(135deg, #d32f2f, #f44336);
            transform: translateY(-1px);
        }
        
        /* æ¬¡å›ä»»æœŸãƒãƒƒã‚¸ */
        .next-term-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff9800, #ffc107);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
        @media (max-width: 768px) {
            .month-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 16px;
            }
            
            .year-title {
                padding: 12px 16px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Ninky</h1>
            <p>ä»»æœŸç®¡ç†ã‚’è‡ªå‹•åŒ–ï¼ãƒ—ãƒ­ã®ãŸã‚ã®å½¹å“¡ç®¡ç†ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‚</p>
        </div>

        <!-- é€šçŸ¥ãƒ‘ãƒãƒ« -->
        <div id="notificationPanel" class="notification-panel">
            <div class="notification-title">ğŸ“… ä»Šæœˆæº€äº†äºˆå®šã®å½¹å“¡ä»»æœŸãŒã‚ã‚Šã¾ã™</div>
            <div id="notificationContent"></div>
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="totalCompanies">0</span>
                <div class="stat-label">ç®¡ç†ä¼šç¤¾æ•°</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalOfficers">0</span>
                <div class="stat-label">ç™»éŒ²å½¹å“¡æ•°</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="expiringSoon">0</span>
                <div class="stat-label">3ãƒ¶æœˆä»¥å†…æº€äº†</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="expired">0</span>
                <div class="stat-label">æº€äº†æ¸ˆã¿</div>
            </div>
        </div>

        <!-- ä¼šç¤¾ãƒ»å½¹å“¡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="card">
            <h2>æ–°è¦ä¼šç¤¾ãƒ»å½¹å“¡ç™»éŒ²</h2>
            <form id="officerForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="corporationType">ä»»æœŸé¡å‹</label>
                        <select id="corporationType" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="general_meeting">å®šæ™‚ç·ä¼šçµ‚çµæ™‚</option>
                            <option value="fixed_years">å›ºå®šå¹´æ•°</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="companyName">ä¼šç¤¾ç­‰æ³•äººå</label>
                        <input type="text" id="companyName" required>
                    </div>
                    <div class="form-group">
                        <label for="fiscalMonth">äº‹æ¥­å¹´åº¦æœ«ï¼ˆæœˆï¼‰</label>
                        <select id="fiscalMonth" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="1">1æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="2">2æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="3">3æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="4">4æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="5">5æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="6">6æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="7">7æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="8">8æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="9">9æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="10">10æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="11">11æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="12">12æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group" id="gracePeriodGroup" style="display: none;">
                        <label for="gracePeriodMonths">å®šæ™‚ç·ä¼šé–‹å‚¬ç›®å®‰ï¼ˆæœˆï¼‰</label>
                        <select id="gracePeriodMonths">
                            <option value="1">1ãƒ¶æœˆ</option>
                            <option value="2">2ãƒ¶æœˆ</option>
                            <option value="3" selected>3ãƒ¶æœˆ</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="officerType">å½¹å“¡ç¨®åˆ¥</label>
                        <select id="officerType" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="å–ç· å½¹">å–ç· å½¹</option>
                            <option value="ç›£æŸ»å½¹">ç›£æŸ»å½¹</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="appointmentDate">å°±ä»»å¹´æœˆæ—¥</label>
                        <input type="date" id="appointmentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="termYears">ä»»æœŸï¼ˆå¹´ï¼‰</label>
                        <select id="termYears" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="1">1å¹´</option>
                            <option value="2">2å¹´</option>
                            <option value="3">3å¹´</option>
                            <option value="4">4å¹´</option>
                            <option value="5">5å¹´</option>
                            <option value="6">6å¹´</option>
                            <option value="7">7å¹´</option>
                            <option value="8">8å¹´</option>
                            <option value="9">9å¹´</option>
                            <option value="10">10å¹´</option>
                        </select>
                    </div>
                </div>
                <button type="submit">å½¹å“¡æƒ…å ±ç™»éŒ²</button>
                <button type="reset">ãƒªã‚»ãƒƒãƒˆ</button>
            </form>
        </div>

        <!-- ç›´è¿‘1å¹´ã®æº€äº†äºˆå®šï¼æº€äº†æ¸ˆï¼ˆä¸€è¦§ï¼‰ -->
        <div class="card">
            <h2>ğŸ“‹ æº€äº†ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆéå»ãƒ»ä»Šæœˆãƒ»æ¥æœˆï¼‰</h2>
            <div id="officerList" class="officer-list"></div>
        </div>

        <!-- æœˆåˆ¥ä»»æœŸæº€äº†ä¸€è¦§ï¼ˆæº€äº†äºˆå®šãŒã‚ã‚‹æœˆã®ã¿è¡¨ç¤ºï¼‰ -->
        <div class="card">
            <h2>ğŸ“… æœˆåˆ¥ä»»æœŸæº€äº†ä¸€è¦§ <span style="font-size: 14px; color: #666; font-weight: normal;">â€»æº€äº†äºˆå®šãŒã‚ã‚‹æœˆã®ã¿è¡¨ç¤º</span></h2>
            <div id="monthlyView" class="month-grid"></div>
            <div class="export-section">
                <input type="file" id="csvInput" accept=".csv" style="display: none;">
                <button id="importBtn">CSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <button id="exportBtn">CSVå‡ºåŠ›</button>
            </div>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>å½¹å“¡æƒ…å ±ç·¨é›†</h2>
            <form id="editForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCorporationType">ä»»æœŸé¡å‹</label>
                        <select id="editCorporationType" required>
                            <option value="general_meeting">å®šæ™‚ç·ä¼šçµ‚çµæ™‚</option>
                            <option value="fixed_years">å›ºå®šå¹´æ•°</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editCompanyName">ä¼šç¤¾ç­‰æ³•äººå</label>
                        <input type="text" id="editCompanyName" required>
                    </div>
                    <div class="form-group">
                        <label for="editFiscalMonth">äº‹æ¥­å¹´åº¦æœ«ï¼ˆæœˆï¼‰</label>
                        <select id="editFiscalMonth" required>
                            <option value="1">1æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="2">2æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="3">3æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="4">4æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="5">5æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="6">6æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="7">7æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="8">8æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="9">9æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="10">10æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="11">11æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                            <option value="12">12æœˆï¼ˆæœ«æ—¥ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group" id="editGracePeriodGroup" style="display: none;">
                        <label for="editGracePeriodMonths">äº‹æ¥­å¹´åº¦çµ‚äº†å¾Œã®å®šæ™‚ç·ä¼šé–‹å‚¬ç›®å®‰ï¼ˆæœˆï¼‰</label>
                        <select id="editGracePeriodMonths">
                            <option value="1">1ãƒ¶æœˆ</option>
                            <option value="2">2ãƒ¶æœˆ</option>
                            <option value="3" selected>3ãƒ¶æœˆ</option>
                        </select>
                        <small style="color: #666; font-size: 0.85em; display: block; margin-top: 5px;">
                            â€» é€šå¸¸ã¯3ãƒ¶æœˆä»¥å†…ã§ã™ã€‚å®Ÿéš›ã®é–‹å‚¬æœˆãŒç¢ºå®šã—ã¦ã„ã‚‹å ´åˆã®ã¿å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
                        </small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editOfficerType">å½¹å“¡ç¨®åˆ¥</label>
                        <select id="editOfficerType" required>
                            <option value="å–ç· å½¹">å–ç· å½¹</option>
                            <option value="ç›£æŸ»å½¹">ç›£æŸ»å½¹</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editAppointmentDate">å°±ä»»å¹´æœˆæ—¥</label>
                        <input type="date" id="editAppointmentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editTermYears">ä»»æœŸï¼ˆå¹´ï¼‰</label>
                        <select id="editTermYears" required>
                            <option value="1">1å¹´</option>
                            <option value="2">2å¹´</option>
                            <option value="3">3å¹´</option>
                            <option value="4">4å¹´</option>
                            <option value="5">5å¹´</option>
                            <option value="6">6å¹´</option>
                            <option value="7">7å¹´</option>
                            <option value="8">8å¹´</option>
                            <option value="9">9å¹´</option>
                            <option value="10">10å¹´</option>
                        </select>
                    </div>
                </div>
                <button type="submit">æ›´æ–°</button>
                <button type="button" onclick="officerManager.closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
        </div>
    </div>

    <script>
        class OfficerManager {
            constructor() {
                this.officers = JSON.parse(localStorage.getItem('officers')) || [];
                this.currentEditId = null;
                this.editingOfficerId = null; // æœˆåˆ¥ä¸€è¦§ã‹ã‚‰ã®ç·¨é›†ç”¨IDç®¡ç†
                
                // ä»»æœŸé¡å‹åˆ¥ã®å½¹å“¡ç¨®åˆ¥å®šç¾©
                this.officerTypesByCorpType = {
                    'general_meeting': [
                        { value: 'å–ç· å½¹', text: 'å–ç· å½¹', defaultTerm: 2 },
                        { value: 'ä»£è¡¨å–ç· å½¹', text: 'ä»£è¡¨å–ç· å½¹', defaultTerm: 2 },
                        { value: 'ç›£æŸ»å½¹', text: 'ç›£æŸ»å½¹', defaultTerm: 4 },
                        { value: 'ç†äº‹', text: 'ç†äº‹', defaultTerm: 2 },
                        { value: 'ä»£è¡¨ç†äº‹', text: 'ä»£è¡¨ç†äº‹', defaultTerm: 2 },
                        { value: 'ä¼šè¨ˆç›£æŸ»äºº', text: 'ä¼šè¨ˆç›£æŸ»äºº', defaultTerm: 1 }
                    ],
                    'fixed_years': [
                        { value: 'ç†äº‹é•·', text: 'ç†äº‹é•·', defaultTerm: 2 },
                        { value: 'ç†äº‹', text: 'ç†äº‹', defaultTerm: 2 },
                        { value: 'ç›£äº‹', text: 'ç›£äº‹', defaultTerm: 2 }
                    ]
                };
                
                // ã€é‡å¤§ãƒã‚°ä¿®æ­£ã€‘æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ä»»æœŸæº€äº†æ—¥ã‚’æ­£ã—ãå†è¨ˆç®—
                this.migrateExistingData();
                
                this.init();
            }

            init() {
                this.renderOfficerList();
                this.renderMonthlyView();
                this.updateStats();
                this.checkNotifications();
                this.setupEventListeners();
                
                // æ¯æ—¥ã®é€šçŸ¥ãƒã‚§ãƒƒã‚¯
                setInterval(() => this.checkNotifications(), 24 * 60 * 60 * 1000);
            }
            
            migrateExistingData() {
                // ã€é‡å¤§ãƒã‚°ä¿®æ­£ï¼‹æ³•äººé¡å‹è¿½åŠ ã€‘æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                let dataUpdated = false;
                
                this.officers.forEach(officer => {
                    // ã€å¾Œæ–¹äº’æ›æ€§ã€‘æ—§å€¤ã‹ã‚‰æ–°å€¤ã¸ã®å¤‰æ›
                    if (officer.termRule === 'company_law' || officer.termRule === 'general_meeting_term') {
                        officer.termRule = 'general_meeting';
                        dataUpdated = true;
                        console.log(`[ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³] ${officer.companyName} ${officer.officerType}: termRuleå¤‰æ› (â†’ general_meeting)`);
                    } else if (officer.termRule === 'fixed_anniversary' || officer.termRule === 'fixed_term') {
                        officer.termRule = 'fixed_years';
                        dataUpdated = true;
                        console.log(`[ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³] ${officer.companyName} ${officer.officerType}: termRuleå¤‰æ› (â†’ fixed_years)`);
                    }
                    
                    // ä»»æœŸé¡å‹ï¼ˆtermRuleï¼‰ãŒæœªè¨­å®šã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                    if (!officer.termRule) {
                        officer.termRule = 'general_meeting'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å®šæ™‚ç·ä¼šçµ‚çµæ™‚
                        dataUpdated = true;
                        console.log(`[ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³] ${officer.companyName} ${officer.officerType}: termRuleè¿½åŠ  (å®šæ™‚ç·ä¼šçµ‚çµæ™‚)`);
                    }
                    
                    // å®šæ™‚ç·ä¼šé–‹å‚¬ç›®å®‰ï¼ˆgracePeriodMonthsï¼‰ãŒæœªè¨­å®šã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
                    if (officer.termRule === 'general_meeting' && !officer.gracePeriodMonths) {
                        officer.gracePeriodMonths = 3; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯3ãƒ¶æœˆ
                        dataUpdated = true;
                        console.log(`[ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³] ${officer.companyName} ${officer.officerType}: gracePeriodMonthsè¿½åŠ  (3ãƒ¶æœˆ)`);
                    }
                    
                    if (officer.appointmentDate && officer.fiscalMonth && officer.termYears) {
                        // ç¾åœ¨ã®æº€äº†æ—¥ã‚’ä¿å­˜
                        const oldExpiryDate = new Date(officer.expiryDate);
                        
                        // æ­£ã—ã„æ–¹å¼ã§å†è¨ˆç®—ï¼ˆtermRuleã¨çŒ¶äºˆæœˆæ•°ã‚’è€ƒæ…®ï¼‰
                        const gracePeriodMonths = officer.gracePeriodMonths || 3;
                        const newExpiryDate = this.calculateExpiryDate(
                            new Date(officer.appointmentDate), 
                            officer.fiscalMonth, 
                            officer.termYears,
                            officer.termRule,
                            gracePeriodMonths
                        );
                        
                        // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸå ´åˆã®ã¿æ›´æ–°
                        if (oldExpiryDate.getTime() !== newExpiryDate.getTime()) {
                            officer.expiryDate = newExpiryDate.toISOString();
                            dataUpdated = true;
                            console.log(`[ãƒã‚°ä¿®æ­£] ${officer.companyName} ${officer.officerType}: ${oldExpiryDate.toLocaleDateString()} â†’ ${newExpiryDate.toLocaleDateString()}`);
                        }
                    }
                });
                
                // ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆã¯ä¿å­˜
                if (dataUpdated) {
                    this.saveData();
                    console.log(`[ãƒã‚°ä¿®æ­£å®Œäº†] ${this.officers.length}ä»¶ã®å½¹å“¡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã€ä¿®æ­£ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`);
                }
            }

            setupEventListeners() {
                // æ³•äººé¡å‹å¤‰æ›´æ™‚ã®å‹•çš„åˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('corporationType').addEventListener('change', (e) => {
                    this.updateOfficerTypeOptions('officerType', e.target.value);
                    this.updateFiscalMonthVisibility(e.target.value);
                });
                
                document.getElementById('editCorporationType').addEventListener('change', (e) => {
                    this.updateOfficerTypeOptions('editOfficerType', e.target.value);
                    this.updateFiscalMonthVisibility(e.target.value, 'edit');
                });
                
                document.getElementById('officerForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addOfficer();
                });

                document.getElementById('editForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateOfficer();
                });

                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportData();
                });

                document.getElementById('importBtn').addEventListener('click', () => {
                    document.getElementById('csvInput').click();
                });

                document.getElementById('csvInput').addEventListener('change', (e) => {
                    this.importData(e);
                });

                // å½¹å“¡ç¨®åˆ¥ã«å¿œã˜ãŸä»»æœŸã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆæ³•äººé¡å‹å¯¾å¿œï¼‰
                document.getElementById('officerType').addEventListener('change', (e) => {
                    const corporationType = document.getElementById('corporationType').value;
                    this.setDefaultTermYears('termYears', corporationType, e.target.value);
                });
                
                document.getElementById('editOfficerType').addEventListener('change', (e) => {
                    const corporationType = document.getElementById('editCorporationType').value;
                    this.setDefaultTermYears('editTermYears', corporationType, e.target.value);
                });

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒ­ãƒ¼ã‚ºã‚¤ãƒ™ãƒ³ãƒˆ
                document.querySelector('.close').addEventListener('click', () => {
                    this.closeEditModal();
                });

                window.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('editModal')) {
                        this.closeEditModal();
                    }
                });
            }
            
            // æ³•äººé¡å‹ã¨å½¹å“¡ç¨®åˆ¥ã«å¿œã˜ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»»æœŸã®è¨­å®š
            setDefaultTermYears(termSelectId, corporationType, officerType) {
                const termSelect = document.getElementById(termSelectId);
                if (!corporationType || !officerType || !termSelect) return;
                
                const officerTypes = this.officerTypesByCorpType[corporationType];
                const selectedType = officerTypes?.find(type => type.value === officerType);
                
                if (selectedType && selectedType.defaultTerm) {
                    termSelect.value = selectedType.defaultTerm.toString();
                }
            }

            // æŒ‡å®šå¹´æœˆã®æœˆæœ«æ—¥ã‚’å–å¾—ã™ã‚‹å…±é€šé–¢æ•°
            getLastDayOfMonth(year, month1to12) {
                // month1to12: 1-12ã®æœˆç•ªå·
                return new Date(year, month1to12, 0).getDate();
            }

            // å’Œæš¦å¤‰æ›é–¢æ•°
            toJapaneseDate(date) {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = d.getMonth() + 1;
                const day = d.getDate();

                let era = '';
                let eraYear = 0;

                if (year >= 2019) {
                    era = 'ä»¤å’Œ';
                    eraYear = year - 2018;
                } else if (year >= 1989) {
                    era = 'å¹³æˆ';
                    eraYear = year - 1988;
                } else if (year >= 1926) {
                    era = 'æ˜­å’Œ';
                    eraYear = year - 1925;
                }

                return `${era}${eraYear}å¹´${month}æœˆ${day}æ—¥`;
            }

            // æœˆåˆ¥ä¸€è¦§ã‹ã‚‰ã®ç·¨é›†ï¼ˆãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’åæ˜ ï¼‰
            editFromMonthly(id) {
                const officer = this.officers.find(o => o.id === id);
                if (!officer) return;

                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
                this.editingOfficerId = id;
                
                // ä»»æœŸé¡å‹ã‚’è¨­å®šï¼ˆæœªè¨­å®šã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
                const termRule = officer.termRule || 'general_meeting';
                document.getElementById('corporationType').value = termRule;
                
                // å½¹å“¡ç¨®åˆ¥é¸æŠè‚¢ã‚’æ›´æ–°
                this.updateOfficerTypeOptions('officerType', termRule);
                
                // äº‹æ¥­å¹´åº¦æœ«è¡¨ç¤ºåˆ¶å¾¡
                this.updateFiscalMonthVisibility(termRule);
                
                // ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
                document.getElementById('companyName').value = officer.companyName;
                document.getElementById('fiscalMonth').value = officer.fiscalMonth;
                document.getElementById('officerType').value = officer.officerType;
                
                // å°±ä»»æ—¥ã‚’ YYYY-MM-DD å½¢å¼ã«å¤‰æ›
                const appointmentDate = new Date(officer.appointmentDate);
                const dateStr = appointmentDate.getFullYear() + '-' + 
                              String(appointmentDate.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(appointmentDate.getDate()).padStart(2, '0');
                document.getElementById('appointmentDate').value = dateStr;
                
                document.getElementById('termYears').value = officer.termYears;
                
                // å®šæ™‚ç·ä¼šé–‹å‚¬ç›®å®‰ã®è¨­å®šï¼ˆå®šæ™‚ç·ä¼šçµ‚çµæ™‚ã®å ´åˆã®ã¿ã€æœªè¨­å®šæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ãƒ¶æœˆï¼‰
                if (termRule === 'general_meeting') {
                    const gracePeriodSelect = document.getElementById('gracePeriodMonths');
                    if (gracePeriodSelect) {
                        gracePeriodSelect.value = officer.gracePeriodMonths || 3;
                    }
                }
                
                // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã€Œæ›´æ–°ã€ã«å¤‰æ›´
                const submitBtn = document.querySelector('#officerForm button[type="submit"]');
                if (submitBtn) {
                    submitBtn.textContent = 'æ›´æ–°';
                }
                
                // ä¸Šéƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            // æ³•äººé¡å‹ã«å¿œã˜ãŸå½¹å“¡ç¨®åˆ¥é¸æŠè‚¢ã®æ›´æ–°
            updateOfficerTypeOptions(selectId, corporationType) {
                const select = document.getElementById(selectId);
                const termSelect = document.getElementById(selectId === 'officerType' ? 'termYears' : 'editTermYears');
                
                // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿å­˜
                const currentValue = select.value;
                
                // é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢
                select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                
                if (corporationType && this.officerTypesByCorpType[corporationType]) {
                    this.officerTypesByCorpType[corporationType].forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.value;
                        option.textContent = type.text;
                        select.appendChild(option);
                    });
                }
                
                // ä»¥å‰ã®é¸æŠå€¤ãŒæ–°ã—ã„é¸æŠè‚¢ã«ã‚ã‚Œã°å¾©å…ƒ
                if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                    select.value = currentValue;
                } else {
                    // ä»»æœŸå¹´æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                    if (termSelect) {
                        termSelect.value = '';
                    }
                }
            }
            
            // äº‹æ¥­å¹´åº¦æœ«å…¥åŠ›æ¬„ã¨å®šæ™‚ç·ä¼šé–‹å‚¬ç›®å®‰å…¥åŠ›æ¬„ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡
            updateFiscalMonthVisibility(corporationType, prefix = '') {
                const fiscalGroup = document.querySelector(`#${prefix}fiscalMonth`.replace(/^#edit/, '#editFiscalMonth').replace(/^#$/, '#fiscalMonth')).closest('.form-group');
                const gracePeriodGroupId = prefix === 'edit' ? 'editGracePeriodGroup' : 'gracePeriodGroup';
                const gracePeriodGroup = document.getElementById(gracePeriodGroupId);
                
                if (corporationType === 'fixed_years') {
                    // å›ºå®šå¹´æ•°ã®å ´åˆã¯äº‹æ¥­å¹´åº¦æœ«ã¨å®šæ™‚ç·ä¼šé–‹å‚¬ç›®å®‰ã‚’éè¡¨ç¤º
                    fiscalGroup.style.display = 'none';
                    if (gracePeriodGroup) {
                        gracePeriodGroup.style.display = 'none';
                    }
                    // å€¤ã‚’ã‚¯ãƒªã‚¢ï¼ˆä»»æœŸè¨ˆç®—ã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã«ãƒ€ãƒŸãƒ¼å€¤ã‚’è¨­å®šï¼‰
                    fiscalGroup.querySelector('select').value = '3'; // ãƒ€ãƒŸãƒ¼å€¤
                } else if (corporationType === 'general_meeting') {
                    // å®šæ™‚ç·ä¼šçµ‚çµæ™‚ã®å ´åˆã¯ä¸¡æ–¹ã¨ã‚‚è¡¨ç¤º
                    fiscalGroup.style.display = 'block';
                    if (gracePeriodGroup) {
                        gracePeriodGroup.style.display = 'block';
                    }
                } else {
                    // æœªé¸æŠã®å ´åˆã¯å®šæ™‚ç·ä¼šé–‹å‚¬ç›®å®‰ã®ã¿éè¡¨ç¤º
                    if (gracePeriodGroup) {
                        gracePeriodGroup.style.display = 'none';
                    }
                }
            }

            addOfficer() {
                const corporationType = document.getElementById('corporationType').value;
                const companyName = document.getElementById('companyName').value;
                const fiscalMonth = parseInt(document.getElementById('fiscalMonth').value);
                const officerType = document.getElementById('officerType').value;
                const appointmentDate = document.getElementById('appointmentDate').value;
                const termYears = parseInt(document.getElementById('termYears').value);
                
                // å®šæ™‚ç·ä¼šé–‹å‚¬ç›®å®‰ã®å–å¾—ï¼ˆå®šæ™‚ç·ä¼šçµ‚çµæ™‚ã®ã¿ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ãƒ¶æœˆï¼‰
                let gracePeriodMonths = 3;
                if (corporationType === 'general_meeting') {
                    const gracePeriodSelect = document.getElementById('gracePeriodMonths');
                    gracePeriodMonths = gracePeriodSelect ? parseInt(gracePeriodSelect.value) || 3 : 3;
                }

                if (this.editingOfficerId) {
                    // æ›´æ–°å‡¦ç†
                    const officerIndex = this.officers.findIndex(o => o.id === this.editingOfficerId);
                    if (officerIndex !== -1) {
                        // æ—¢å­˜ã®officerã‚’æ›´æ–°
                        this.officers[officerIndex] = {
                            ...this.officers[officerIndex], // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
                            termRule: corporationType,
                            gracePeriodMonths: gracePeriodMonths,
                            companyName,
                            fiscalMonth,
                            officerType,
                            appointmentDate: new Date(appointmentDate),
                            termYears,
                            expiryDate: this.calculateExpiryDate(new Date(appointmentDate), fiscalMonth, termYears, corporationType, gracePeriodMonths),
                            updatedAt: new Date()
                        };
                        
                        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
                        this.editingOfficerId = null;
                        
                        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã€Œç™»éŒ²ã€ã«æˆ»ã™
                        const submitBtn = document.querySelector('#officerForm button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.textContent = 'ç™»éŒ²';
                        }
                        
                        alert('å½¹å“¡æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚\n\nâ€» å®Ÿéš›ã®ä»»æœŸæœŸé–“ã¯å®šæ¬¾ç­‰ã‚’ã”ç¢ºèªãã ã•ã„ã€‚\næœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ä»»æœŸæº€äº†äºˆå®šæ—¥ã®ç›®å®‰ã‚’æä¾›ã—ã¾ã™ã€‚');
                    }
                } else {
                    // æ–°è¦è¿½åŠ å‡¦ç†
                    const officer = {
                        id: Date.now(),
                        termRule: corporationType,
                        gracePeriodMonths: gracePeriodMonths,
                        companyName,
                        fiscalMonth,
                        officerType,
                        appointmentDate: new Date(appointmentDate),
                        termYears,
                        expiryDate: this.calculateExpiryDate(new Date(appointmentDate), fiscalMonth, termYears, corporationType, gracePeriodMonths),
                        createdAt: new Date()
                    };

                    this.officers.push(officer);
                    alert('å½¹å“¡æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚\n\nâ€» å®Ÿéš›ã®ä»»æœŸæœŸé–“ã¯å®šæ¬¾ç­‰ã‚’ã”ç¢ºèªãã ã•ã„ã€‚\næœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ä»»æœŸæº€äº†äºˆå®šæ—¥ã®ç›®å®‰ã‚’æä¾›ã—ã¾ã™ã€‚');
                }

                // å…±é€šã®å¾Œå‡¦ç†
                this.saveData();
                this.renderOfficerList();
                this.renderMonthlyView();
                this.updateStats();
                this.checkNotifications();
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('officerForm').reset();
            }

            editOfficer(id) {
                const officer = this.officers.find(o => o.id === id);
                if (!officer) return;

                this.currentEditId = id;
                
                // ä»»æœŸé¡å‹ã‚’è¨­å®šï¼ˆæœªè¨­å®šã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
                const termRule = officer.termRule || 'general_meeting';
                document.getElementById('editCorporationType').value = termRule;
                
                // å½¹å“¡ç¨®åˆ¥é¸æŠè‚¢ã‚’æ›´æ–°
                this.updateOfficerTypeOptions('editOfficerType', termRule);
                
                // äº‹æ¥­å¹´åº¦æœ«è¡¨ç¤ºåˆ¶å¾¡
                this.updateFiscalMonthVisibility(termRule, 'edit');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                document.getElementById('editCompanyName').value = officer.companyName;
                document.getElementById('editFiscalMonth').value = officer.fiscalMonth;
                document.getElementById('editOfficerType').value = officer.officerType;
                document.getElementById('editAppointmentDate').value = officer.appointmentDate.toISOString().split('T')[0];
                document.getElementById('editTermYears').value = officer.termYears;
                
                // å®šæ™‚ç·ä¼šé–‹å‚¬ç›®å®‰ã®è¨­å®šï¼ˆå®šæ™‚ç·ä¼šçµ‚çµæ™‚ã®å ´åˆã®ã¿ã€æœªè¨­å®šæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ãƒ¶æœˆï¼‰
                if (termRule === 'general_meeting') {
                    const gracePeriodSelect = document.getElementById('editGracePeriodMonths');
                    if (gracePeriodSelect) {
                        gracePeriodSelect.value = officer.gracePeriodMonths || 3;
                    }
                }

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                document.getElementById('editModal').style.display = 'block';
            }

            updateOfficer() {
                if (!this.currentEditId) return;

                const officerIndex = this.officers.findIndex(o => o.id === this.currentEditId);
                if (officerIndex === -1) return;

                const corporationType = document.getElementById('editCorporationType').value;
                const companyName = document.getElementById('editCompanyName').value;
                const fiscalMonth = parseInt(document.getElementById('editFiscalMonth').value);
                const officerType = document.getElementById('editOfficerType').value;
                const appointmentDate = document.getElementById('editAppointmentDate').value;
                const termYears = parseInt(document.getElementById('editTermYears').value);
                
                // å®šæ™‚ç·ä¼šé–‹å‚¬ç›®å®‰ã®å–å¾—ï¼ˆå®šæ™‚ç·ä¼šçµ‚çµæ™‚ã®ã¿ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ãƒ¶æœˆï¼‰
                let gracePeriodMonths = 3;
                if (corporationType === 'general_meeting') {
                    const gracePeriodSelect = document.getElementById('editGracePeriodMonths');
                    gracePeriodMonths = gracePeriodSelect ? parseInt(gracePeriodSelect.value) || 3 : 3;
                }

                this.officers[officerIndex] = {
                    ...this.officers[officerIndex],
                    termRule: corporationType,
                    gracePeriodMonths: gracePeriodMonths,
                    companyName,
                    fiscalMonth,
                    officerType,
                    appointmentDate: new Date(appointmentDate),
                    termYears,
                    expiryDate: this.calculateExpiryDate(new Date(appointmentDate), fiscalMonth, termYears, corporationType, gracePeriodMonths)
                };

                this.saveData();
                this.renderOfficerList();
                this.renderMonthlyView();
                this.updateStats();
                this.checkNotifications();
                this.closeEditModal();

                alert('å½¹å“¡æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚\n\nâ€» å®Ÿéš›ã®ä»»æœŸæœŸé–“ã¯å®šæ¬¾ç­‰ã‚’ã”ç¢ºèªãã ã•ã„ã€‚\næœ¬ã‚·ã‚¹ãƒ†ãƒ ã¯ä»»æœŸæº€äº†äºˆå®šæ—¥ã®ç›®å®‰ã‚’æä¾›ã—ã¾ã™ã€‚');
            }

            closeEditModal() {
                document.getElementById('editModal').style.display = 'none';
                this.currentEditId = null;
            }

            calculateExpiryDate(appointmentDate, fiscalMonth, termYears, termRule = 'general_meeting', gracePeriodMonths = 3) {
                if (termRule === 'fixed_years') {
                    // ã€å›ºå®šå¹´æ•°ã€‘å°±ä»»æ—¥ + ä»»æœŸå¹´æ•° = ä»»æœŸæº€äº†æ—¥ï¼ˆã‚·ãƒ³ãƒ—ãƒ«è¨ˆç®—ï¼‰
                    const expiryDate = new Date(appointmentDate);
                    expiryDate.setFullYear(appointmentDate.getFullYear() + termYears);
                    return expiryDate;
                } else {
                    // ã€å®šæ™‚ç·ä¼šçµ‚çµæ™‚ã€‘äº‹æ¥­å¹´åº¦ã«åŸºã¥ãä»»æœŸè¨ˆç®—
                    // ã€Œãã®é¸ä»»å¾Œâ—¯å¹´ä»¥å†…ã«çµ‚äº†ã™ã‚‹äº‹æ¥­å¹´åº¦ã«é–¢ã™ã‚‹å®šæ™‚æ ªä¸»ç·ä¼šã®çµ‚çµã®æ™‚ã¾ã§ã€
                    
                    // 1. æº€äº†å¿œç­”æ—¥A = å°±ä»»æ—¥ + ä»»æœŸå¹´æ•°
                    const A = new Date(appointmentDate);
                    A.setFullYear(appointmentDate.getFullYear() + termYears);
                    
                    // 2. candidateFYEnd = A.year ã®äº‹æ¥­å¹´åº¦æœ«æ—¥
                    const candidateFYEnd = new Date(A.getFullYear(), fiscalMonth - 1, this.getLastDayOfMonth(A.getFullYear(), fiscalMonth));
                    
                    let fiscalYearEnd;
                    
                    // 3. æ­£ã—ã„åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè£•ç´€ã•ã‚“ã”æŒ‡å°ï¼‰
                    if (A < candidateFYEnd) {
                        // A < candidateFYEnd ã®å ´åˆï¼šå‰å¹´åº¦æœ«ã‚’æ¡ç”¨
                        fiscalYearEnd = new Date(A.getFullYear() - 1, fiscalMonth - 1, this.getLastDayOfMonth(A.getFullYear() - 1, fiscalMonth));
                    } else {
                        // A >= candidateFYEnd ã®å ´åˆï¼šå½“å¹´åº¦æœ«ã‚’æ¡ç”¨
                        fiscalYearEnd = candidateFYEnd;
                    }
                    
                    // 4. ä»»æœŸæº€äº†æ—¥ = fiscalYearEnd + å®šæ™‚æ ªä¸»ç·ä¼šã¾ã§ã®çŒ¶äºˆæœˆæ•°ã®æœˆæœ«æ—¥
                    let expiryMonth = fiscalMonth + gracePeriodMonths;
                    let expiryYear = fiscalYearEnd.getFullYear();
                    
                    if (expiryMonth > 12) {
                        expiryMonth -= 12;
                        expiryYear += 1;
                    }
                    
                    const lastDayOfMonth = this.getLastDayOfMonth(expiryYear, expiryMonth);
                    
                    return new Date(expiryYear, expiryMonth - 1, lastDayOfMonth);
                }
            }

            deleteOfficer(id) {
                const officer = this.officers.find(o => o.id === id);
                if (!officer) return;
                
                const deleteConfirm = confirm(`ã“ã®å½¹å“¡æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã€${officer.companyName}ã€‘\n${officer.officerType} (${officer.termYears}å¹´ä»»æœŸ)\næº€äº†äºˆå®šæ—¥: ${this.toJapaneseDate(officer.expiryDate)}`);
                
                if (deleteConfirm) {
                    // æ¬¡å›ä»»æœŸã®è‡ªå‹•ç”Ÿæˆç¢ºèª
                    const nextTermConfirm = confirm('å‰Šé™¤å¾Œã€åŒã˜å½¹å“¡ã®æ¬¡å›ä»»æœŸã‚’è‡ªå‹•ã§ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\nã€ŒOKã€: æ¬¡å›ä»»æœŸã‚’è‡ªå‹•ç”Ÿæˆ\nã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€: å®Œå…¨å‰Šé™¤ã®ã¿');
                    
                    if (nextTermConfirm) {
                        // æ¬¡å›ä»»æœŸã®è‡ªå‹•è¨ˆç®—ãƒ»ç”Ÿæˆ
                        const nextAppointmentDate = new Date(officer.expiryDate);
                        // æº€äº†æ—¥ã®ç¿Œæ—¥ã‚’æ¬¡å›å°±ä»»æ—¥ã¨ã™ã‚‹
                        nextAppointmentDate.setDate(nextAppointmentDate.getDate() + 1);
                        
                        const nextOfficer = {
                            id: Date.now() + 1, // é‡è¤‡å›é¿
                            termRule: officer.termRule, // åŒã˜æ³•äººé¡å‹
                            gracePeriodMonths: officer.gracePeriodMonths || 3, // åŒã˜çŒ¶äºˆæœˆæ•°
                            companyName: officer.companyName,
                            fiscalMonth: officer.fiscalMonth,
                            officerType: officer.officerType,
                            appointmentDate: nextAppointmentDate,
                            termYears: officer.termYears, // åŒã˜ä»»æœŸå¹´æ•°
                            expiryDate: this.calculateExpiryDate(nextAppointmentDate, officer.fiscalMonth, officer.termYears, officer.termRule, officer.gracePeriodMonths || 3),
                            createdAt: new Date(),
                            isNextTerm: true // æ¬¡å›ä»»æœŸãƒ•ãƒ©ã‚°
                        };
                        
                        // å…ƒãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€æ¬¡å›ä»»æœŸãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                        this.officers = this.officers.filter(o => o.id !== id);
                        this.officers.push(nextOfficer);
                        
                        alert(`å½¹å“¡æƒ…å ±ã‚’å‰Šé™¤ã—ã€æ¬¡å›ä»»æœŸã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã—ãŸã€‚\n\næ¬¡å›ä»»æœŸæº€äº†äºˆå®šæ—¥: ${this.toJapaneseDate(nextOfficer.expiryDate)}`);
                    } else {
                        // å®Œå…¨å‰Šé™¤ã®ã¿
                        this.officers = this.officers.filter(o => o.id !== id);
                        alert('å½¹å“¡æƒ…å ±ã‚’å®Œå…¨å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                    }
                    
                    // UIæ›´æ–°
                    this.saveData();
                    this.renderOfficerList();
                    this.renderMonthlyView();
                    this.updateStats();
                    this.checkNotifications();
                }
            }

            renderOfficerList() {
                const listElement = document.getElementById('officerList');
                const today = new Date();
                
                // ä»Šæœˆã®é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å–å¾—
                const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const thisMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);
                
                // æ¥æœˆã®é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å–å¾—
                const nextMonthStart = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                const nextMonthEnd = new Date(today.getFullYear(), today.getMonth() + 2, 0, 23, 59, 59);
                
                // æº€äº†æ¸ˆã¿ï¼ˆä»Šæ—¥ã‚ˆã‚Šå‰ï¼‰
                const expiredList = this.officers.filter(officer => {
                    const expiryDate = new Date(officer.expiryDate);
                    return expiryDate < today;
                }).sort((a, b) => new Date(b.expiryDate) - new Date(a.expiryDate)); // æ–°ã—ã„é †
                
                // ä»Šæœˆæº€äº†
                const thisMonthList = this.officers.filter(officer => {
                    const expiryDate = new Date(officer.expiryDate);
                    return expiryDate >= thisMonthStart && expiryDate <= thisMonthEnd;
                }).sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
                
                // æ¥æœˆæº€äº†
                const nextMonthList = this.officers.filter(officer => {
                    const expiryDate = new Date(officer.expiryDate);
                    return expiryDate >= nextMonthStart && expiryDate <= nextMonthEnd;
                }).sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate));
                
                // è¡¨ç¤ºå¯¾è±¡ãŒãªã„å ´åˆ
                if (thisMonthList.length === 0 && nextMonthList.length === 0 && expiredList.length === 0) {
                    listElement.innerHTML = '<p>è¡¨ç¤ºå¯¾è±¡ã®æº€äº†äºˆå®šãƒ»æº€äº†æ¸ˆã¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                    return;
                }
                
                // HTMLç”Ÿæˆ
                let html = '';
                
                // ä»Šæœˆæº€äº†äºˆå®šãƒ–ãƒ­ãƒƒã‚¯
                if (thisMonthList.length > 0) {
                    html += `
                        <div class="expiry-block upcoming-block">
                            <h4 class="block-title">ğŸ“… ä»Šæœˆæº€äº†äºˆå®šï¼ˆ${thisMonthList.length}ä»¶ï¼‰</h4>
                            <div class="officer-items">
                    `;
                    
                    thisMonthList.forEach(officer => {
                        const expiryDate = new Date(officer.expiryDate);
                        const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                        
                        let expiryClass = 'expiry-critical';
                        let expiryText = `âš ï¸ æº€äº†ã¾ã§${daysUntilExpiry}æ—¥`;
                        
                        if (daysUntilExpiry < 0) {
                            expiryText = `æº€äº†: ${this.toJapaneseDate(expiryDate)}`;
                        }
                        
                        html += `
                            <div class="officer-item">
                                <div class="officer-info">
                                    <strong>${officer.companyName}${officer.isNextTerm ? ' ğŸ”„' : ''}</strong>
                                    ${officer.isNextTerm ? '<span class="next-term-badge">æ¬¡å›ä»»æœŸ</span>' : ''}
                                    <div class="officer-details">
                                        ${officer.officerType} | å°±ä»»: ${this.toJapaneseDate(officer.appointmentDate)} | 
                                        ä»»æœŸ: ${officer.termYears}å¹´ | äº‹æ¥­å¹´åº¦æœ«: ${officer.fiscalMonth}æœˆï¼ˆæœ«æ—¥ï¼‰
                                    </div>
                                </div>
                                <div class="expiry-date ${expiryClass}">
                                    ${expiryText}
                                </div>
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="officerManager.editOfficer(${officer.id})">ç·¨é›†</button>
                                    <button class="delete-btn" onclick="officerManager.deleteOfficer(${officer.id})">å‰Šé™¤</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // æ¥æœˆæº€äº†äºˆå®šãƒ–ãƒ­ãƒƒã‚¯
                if (nextMonthList.length > 0) {
                    html += `
                        <div class="expiry-block upcoming-block">
                            <h4 class="block-title">ğŸ“… æ¥æœˆæº€äº†äºˆå®šï¼ˆ${nextMonthList.length}ä»¶ï¼‰</h4>
                            <div class="officer-items">
                    `;
                    
                    nextMonthList.forEach(officer => {
                        const expiryDate = new Date(officer.expiryDate);
                        const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                        
                        let expiryClass = 'expiry-soon';
                        let expiryText = `æº€äº†ã¾ã§${daysUntilExpiry}æ—¥`;
                        
                        html += `
                            <div class="officer-item">
                                <div class="officer-info">
                                    <strong>${officer.companyName}${officer.isNextTerm ? ' ğŸ”„' : ''}</strong>
                                    ${officer.isNextTerm ? '<span class="next-term-badge">æ¬¡å›ä»»æœŸ</span>' : ''}
                                    <div class="officer-details">
                                        ${officer.officerType} | å°±ä»»: ${this.toJapaneseDate(officer.appointmentDate)} | 
                                        ä»»æœŸ: ${officer.termYears}å¹´ | äº‹æ¥­å¹´åº¦æœ«: ${officer.fiscalMonth}æœˆï¼ˆæœ«æ—¥ï¼‰
                                    </div>
                                </div>
                                <div class="expiry-date ${expiryClass}">
                                    ${expiryText}
                                </div>
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="officerManager.editOfficer(${officer.id})">ç·¨é›†</button>
                                    <button class="delete-btn" onclick="officerManager.deleteOfficer(${officer.id})">å‰Šé™¤</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // æº€äº†æ¸ˆã¿ãƒ–ãƒ­ãƒƒã‚¯
                if (expiredList.length > 0) {
                    html += `
                        <div class="expiry-block expired-block">
                            <h4 class="block-title">âœ… æº€äº†æ¸ˆã¿ï¼ˆ${expiredList.length}ä»¶ï¼‰</h4>
                            <div class="officer-items">
                    `;
                    
                    expiredList.forEach(officer => {
                        const expiryDate = new Date(officer.expiryDate);
                        const daysSinceExpiry = Math.floor((today - expiryDate) / (1000 * 60 * 60 * 24));
                        
                        // æº€äº†æ—¥ã®è¥¿æš¦è¡¨ç¤º
                        const expiryDateStr = `${expiryDate.getFullYear()}/${String(expiryDate.getMonth() + 1).padStart(2, '0')}/${String(expiryDate.getDate()).padStart(2, '0')}`;
                        
                        html += `
                            <div class="officer-item expired-item">
                                <div class="officer-info">
                                    <strong>${officer.companyName}${officer.isNextTerm ? ' ğŸ”„' : ''}</strong>
                                    ${officer.isNextTerm ? '<span class="next-term-badge">æ¬¡å›ä»»æœŸ</span>' : ''}
                                    <div class="officer-details">
                                        ${officer.officerType} | å°±ä»»: ${this.toJapaneseDate(officer.appointmentDate)} | 
                                        ä»»æœŸ: ${officer.termYears}å¹´ | äº‹æ¥­å¹´åº¦æœ«: ${officer.fiscalMonth}æœˆï¼ˆæœ«æ—¥ï¼‰<br>
                                        æº€äº†æ—¥ï¼š${expiryDateStr}ï¼ˆ${this.toJapaneseDate(expiryDate)}ï¼‰
                                    </div>
                                </div>
                                <div class="expiry-date expiry-expired">
                                    æº€äº†æ¸ˆã¿ï¼ˆ${daysSinceExpiry}æ—¥çµŒéï¼‰
                                </div>
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="officerManager.editOfficer(${officer.id})">ç·¨é›†</button>
                                    <button class="delete-btn" onclick="officerManager.deleteOfficer(${officer.id})">å‰Šé™¤</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                listElement.innerHTML = html;
            }

            renderMonthlyView() {
                const monthlyElement = document.getElementById('monthlyView');
                const monthlyData = {};
                
                // æœˆåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆãƒ‡ãƒ¼ã‚¿å´ã‹ã‚‰å­˜åœ¨ã™ã‚‹å¹´æœˆã®ã¿ï¼‰
                this.officers.forEach(officer => {
                    const expiryDate = new Date(officer.expiryDate);
                    const monthKey = `${expiryDate.getFullYear()}-${String(expiryDate.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = [];
                    }
                    monthlyData[monthKey].push(officer);
                });
                
                // æº€äº†äºˆå®šãŒã‚ã‚‹å¹´æœˆã®ã¿æŠ½å‡ºã—ã¦ã‚½ãƒ¼ãƒˆ
                const existingMonths = Object.keys(monthlyData)
                    .sort() // YYYY-MM å½¢å¼ãªã®ã§æ–‡å­—åˆ—ã‚½ãƒ¼ãƒˆã§æ­£ã—ãä¸¦ã¶
                    .map(monthKey => {
                        const [year, month] = monthKey.split('-');
                        return {
                            key: monthKey,
                            year: parseInt(year),
                            month: parseInt(month),
                            display: `${year}å¹´${month}æœˆ`,
                            officers: monthlyData[monthKey]
                        };
                    });
                
                if (existingMonths.length === 0) {
                    monthlyElement.innerHTML = '<p>æº€äº†äºˆå®šã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                    return;
                }
                
                // å¹´åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
                const yearGroups = {};
                existingMonths.forEach(monthData => {
                    const year = monthData.year;
                    if (!yearGroups[year]) {
                        yearGroups[year] = [];
                    }
                    yearGroups[year].push(monthData);
                });
                
                // HTMLç”Ÿæˆï¼ˆå¹´ãƒ•ãƒ¬ãƒ¼ãƒ åˆ¥ï¼‰
                let html = '';
                
                Object.keys(yearGroups)
                    .sort((a, b) => parseInt(a) - parseInt(b)) // å¹´æ˜‡é †
                    .forEach(year => {
                        const yearData = yearGroups[year];
                        const totalCount = yearData.reduce((sum, month) => sum + month.officers.length, 0);
                        
                        // ä»¤å’Œå¹´ã®è¨ˆç®—
                        const reiwaYear = parseInt(year) - 2018;
                        const yearDisplay = reiwaYear > 0 ? `${year}å¹´ï¼ˆä»¤å’Œ${reiwaYear}å¹´ï¼‰` : `${year}å¹´`;
                        
                        html += `
                            <div class="year-frame">
                                <div class="year-title">${yearDisplay}ï¼ˆåˆè¨ˆ${totalCount}ä»¶ï¼‰</div>
                                <div class="month-grid">
                        `;
                        
                        yearData.forEach(monthData => {
                            html += `
                                <div class="month-card">
                                    <div class="month-header">
                                        ${monthData.month}æœˆ (${monthData.officers.length}ä»¶)
                                    </div>
                                    <div class="month-content">
                                        ${monthData.officers.map(officer => `
                                            <div class="company-expiry">
                                                <div class="company-info">
                                                    <strong>${officer.companyName}${officer.isNextTerm ? ' ğŸ”„' : ''}</strong>
                                                    ${officer.isNextTerm ? '<br><span class="next-term-badge">æ¬¡å›ä»»æœŸ</span>' : ''}
                                                    <br>${officer.officerType} (${officer.termYears}å¹´ä»»æœŸ)<br>
                                                    æº€äº†æ—¥: ${this.toJapaneseDate(officer.expiryDate)}
                                                </div>
                                                <div class="month-actions">
                                                    <button class="edit-btn" onclick="officerManager.editFromMonthly(${officer.id})">ç·¨é›†</button>
                                                    <button class="delete-btn" onclick="officerManager.deleteOfficer(${officer.id})">å‰Šé™¤</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                
                monthlyElement.innerHTML = html;
            }

            updateStats() {
                const totalCompanies = new Set(this.officers.map(o => o.companyName)).size;
                const totalOfficers = this.officers.length;
                const today = new Date();
                const threeMonthsLater = new Date(today.getTime() + 90 * 24 * 60 * 60 * 1000);
                
                const expiringSoon = this.officers.filter(officer => {
                    const expiryDate = new Date(officer.expiryDate);
                    return expiryDate >= today && expiryDate <= threeMonthsLater;
                }).length;
                
                const expired = this.officers.filter(officer => {
                    const expiryDate = new Date(officer.expiryDate);
                    return expiryDate < today;
                }).length;

                document.getElementById('totalCompanies').textContent = totalCompanies;
                document.getElementById('totalOfficers').textContent = totalOfficers;
                document.getElementById('expiringSoon').textContent = expiringSoon;
                document.getElementById('expired').textContent = expired;
            }

            checkNotifications() {
                const today = new Date();
                const currentMonth = today.getMonth() + 1;
                const currentYear = today.getFullYear();
                
                // ä»Šæœˆæº€äº†ã®å½¹å“¡ã‚’å–å¾—
                const thisMonthExpiring = this.officers.filter(officer => {
                    const expiryDate = new Date(officer.expiryDate);
                    return expiryDate.getMonth() + 1 === currentMonth && 
                           expiryDate.getFullYear() === currentYear;
                });

                if (thisMonthExpiring.length > 0) {
                    this.showNotification(thisMonthExpiring);
                } else {
                    document.getElementById('notificationPanel').style.display = 'none';
                }
            }

            showNotification(officers) {
                const panel = document.getElementById('notificationPanel');
                const content = document.getElementById('notificationContent');
                
                content.innerHTML = officers.map(officer => `
                    <div class="notification-item">
                        ğŸ“… ${officer.companyName} - ${officer.officerType} 
                        (æº€äº†æ—¥: ${this.toJapaneseDate(officer.expiryDate)})
                    </div>
                `).join('');
                
                panel.style.display = 'block';
                
                // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã®é€ä¿¡ï¼ˆæ¨©é™ãŒã‚ã‚‹å ´åˆï¼‰
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('å½¹å“¡ä»»æœŸæº€äº†é€šçŸ¥', {
                        body: `${officers.length}ä»¶ã®å½¹å“¡ä»»æœŸãŒä»Šæœˆæº€äº†äºˆå®šã§ã™ã€‚`,
                        icon: 'ğŸ“…'
                    });
                }
            }

            exportData() {
                const csvData = [
                    ['ä¼šç¤¾å', 'å½¹å“¡ç¨®åˆ¥', 'å°±ä»»æ—¥', 'ä»»æœŸå¹´æ•°', 'äº‹æ¥­å¹´åº¦æœ«æœˆ', 'çŒ¶äºˆæœˆæ•°', 'æº€äº†äºˆå®šæ—¥'],
                    ...this.officers.map(officer => [
                        officer.companyName,
                        officer.officerType,
                        this.toJapaneseDate(officer.appointmentDate),
                        officer.termYears + 'å¹´',
                        officer.fiscalMonth + 'æœˆï¼ˆæœ«æ—¥ï¼‰',
                        officer.termRule === 'general_meeting' ? (officer.gracePeriodMonths || 3) + 'ãƒ¶æœˆ' : 'N/A',
                        this.toJapaneseDate(officer.expiryDate)
                    ])
                ];

                const csvContent = csvData.map(row => 
                    row.map(field => `"${field}"`).join(',')
                ).join('\n');

                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `å½¹å“¡ä»»æœŸç®¡ç†_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }

            // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
            importData(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.name.endsWith('.csv')) {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const rows = this.parseCSV(text);
                        
                        if (rows.length === 0) {
                            alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™ã€‚');
                            return;
                        }

                        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ãƒã‚§ãƒƒã‚¯
                        const header = rows[0];
                        const expectedHeaders = ['ä¼šç¤¾å', 'å½¹å“¡ç¨®åˆ¥', 'å°±ä»»æ—¥', 'ä»»æœŸå¹´æ•°', 'äº‹æ¥­å¹´åº¦æœ«æœˆ'];
                        
                        const validHeaders = expectedHeaders.every(h => 
                            header.some(col => col.includes(h) || h.includes(col.replace(/"/g, '').trim()))
                        );

                        if (!validHeaders) {
                            if (confirm('CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæƒ³å®šã¨ç•°ãªã‚Šã¾ã™ã€‚ãã‚Œã§ã‚‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ\n\næœŸå¾…ã•ã‚Œã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼: ' + expectedHeaders.join(', '))) {
                                // ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ã¨ã—ã¦å‡¦ç†
                            } else {
                                return;
                            }
                        }

                        // ãƒ‡ãƒ¼ã‚¿è¡Œã®å‡¦ç†ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
                        const dataRows = validHeaders ? rows.slice(1) : rows;
                        const importedOfficers = [];
                        const errors = [];

                        dataRows.forEach((row, index) => {
                            try {
                                const officer = this.parseOfficerFromCSV(row, index + (validHeaders ? 2 : 1));
                                if (officer) {
                                    importedOfficers.push(officer);
                                }
                            } catch (error) {
                                errors.push(`è¡Œ${index + (validHeaders ? 2 : 1)}: ${error.message}`);
                            }
                        });

                        if (errors.length > 0) {
                            const continueImport = confirm(`${errors.length}ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™:\n\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? '\n...(ä»–' + (errors.length - 5) + 'ä»¶)' : ''}\n\næ­£å¸¸ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ`);
                            if (!continueImport) {
                                return;
                            }
                        }

                        if (importedOfficers.length === 0) {
                            alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                            return;
                        }

                        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
                        const duplicateCount = importedOfficers.filter(newOfficer => 
                            this.officers.some(existingOfficer => 
                                existingOfficer.companyName === newOfficer.companyName &&
                                existingOfficer.officerType === newOfficer.officerType &&
                                new Date(existingOfficer.appointmentDate).getTime() === new Date(newOfficer.appointmentDate).getTime()
                            )
                        ).length;

                        let confirmMessage = `${importedOfficers.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚`;
                        if (duplicateCount > 0) {
                            confirmMessage += `\nï¼ˆ${duplicateCount}ä»¶ã®é‡è¤‡ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¾ã™ï¼‰`;
                        }
                        if (errors.length > 0) {
                            confirmMessage += `\nï¼ˆ${errors.length}ä»¶ã®ã‚¨ãƒ©ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯é™¤å¤–ã•ã‚Œã¾ã™ï¼‰`;
                        }

                        if (confirm(confirmMessage + '\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                            this.officers.push(...importedOfficers);
                            this.saveData();
                            this.renderOfficerList();
                            this.renderMonthlyView();
                            this.updateStats();
                            this.checkNotifications();

                            alert(`${importedOfficers.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚` + 
                                  (errors.length > 0 ? `\n${errors.length}ä»¶ã®ã‚¨ãƒ©ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯é™¤å¤–ã•ã‚Œã¾ã—ãŸã€‚` : ''));
                        }

                    } catch (error) {
                        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message);
                    }

                    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
                    event.target.value = '';
                };

                reader.readAsText(file, 'UTF-8');
            }

            // CSVè§£ææ©Ÿèƒ½
            parseCSV(text) {
                const lines = text.split('\n').filter(line => line.trim());
                return lines.map(line => {
                    const columns = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            if (inQuotes && line[i + 1] === '"') {
                                current += '"';
                                i++; // Skip next quote
                            } else {
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            columns.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    columns.push(current.trim());
                    
                    return columns.map(col => col.replace(/^"|"$/g, ''));
                });
            }

            // CSVè¡Œã‹ã‚‰å½¹å“¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
            parseOfficerFromCSV(row, rowNumber) {
                if (row.length < 5) {
                    throw new Error(`ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆ${row.length}åˆ—ï¼‰`);
                }

                const [companyName, officerType, appointmentDateStr, termYearsStr, fiscalMonthStr] = row;

                // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
                if (!companyName || !officerType || !appointmentDateStr || !termYearsStr || !fiscalMonthStr) {
                    throw new Error('å¿…é ˆé …ç›®ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }

                // å°±ä»»æ—¥ã®è§£æï¼ˆå’Œæš¦ãƒ»è¥¿æš¦ä¸¡å¯¾å¿œï¼‰
                let appointmentDate;
                try {
                    appointmentDate = this.parseJapaneseDate(appointmentDateStr);
                    if (!appointmentDate) {
                        // è¥¿æš¦ã§ã®è§£æã‚’è©¦è¡Œ
                        appointmentDate = new Date(appointmentDateStr.replace(/å¹´|æœˆ|æ—¥/g, match => 
                            match === 'å¹´' ? '-' : match === 'æœˆ' ? '-' : ''
                        ));
                    }
                    if (isNaN(appointmentDate.getTime())) {
                        throw new Error('æ—¥ä»˜å½¢å¼ãŒç„¡åŠ¹ã§ã™');
                    }
                } catch (e) {
                    throw new Error(`å°±ä»»æ—¥ã®è§£æã«å¤±æ•—: ${appointmentDateStr}`);
                }

                // ä»»æœŸå¹´æ•°ã®è§£æ
                const termYears = parseInt(termYearsStr.replace(/å¹´/g, ''));
                if (isNaN(termYears) || termYears < 1 || termYears > 10) {
                    throw new Error(`ä»»æœŸå¹´æ•°ãŒç„¡åŠ¹ã§ã™: ${termYearsStr}`);
                }

                // äº‹æ¥­å¹´åº¦æœ«æœˆã®è§£æ
                const fiscalMonth = parseInt(fiscalMonthStr.replace(/æœˆ/g, ''));
                if (isNaN(fiscalMonth) || fiscalMonth < 1 || fiscalMonth > 12) {
                    throw new Error(`äº‹æ¥­å¹´åº¦æœ«æœˆãŒç„¡åŠ¹ã§ã™: ${fiscalMonthStr}`);
                }

                // å½¹å“¡ç¨®åˆ¥ã®ãƒã‚§ãƒƒã‚¯
                if (!['å–ç· å½¹', 'ç›£æŸ»å½¹'].includes(officerType)) {
                    throw new Error(`å½¹å“¡ç¨®åˆ¥ãŒç„¡åŠ¹ã§ã™: ${officerType}`);
                }

                return {
                    id: Date.now() + Math.random(), // é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ãƒ©ãƒ³ãƒ€ãƒ è¦ç´ ã‚’è¿½åŠ 
                    termRule: 'general_meeting', // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å®šæ™‚ç·ä¼šçµ‚çµæ™‚
                    gracePeriodMonths: 3, // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ãƒ¶æœˆ
                    companyName: companyName.trim(),
                    fiscalMonth,
                    officerType: officerType.trim(),
                    appointmentDate,
                    termYears,
                    expiryDate: this.calculateExpiryDate(appointmentDate, fiscalMonth, termYears, 'general_meeting', 3),
                    createdAt: new Date()
                };
            }

            // å’Œæš¦æ–‡å­—åˆ—ã‚’æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
            parseJapaneseDate(dateStr) {
                const patterns = [
                    { regex: /ä»¤å’Œ(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/, baseYear: 2018 },
                    { regex: /å¹³æˆ(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/, baseYear: 1988 },
                    { regex: /æ˜­å’Œ(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/, baseYear: 1925 }
                ];

                for (const pattern of patterns) {
                    const match = dateStr.match(pattern.regex);
                    if (match) {
                        const [, eraYear, month, day] = match;
                        const year = pattern.baseYear + parseInt(eraYear);
                        return new Date(year, parseInt(month) - 1, parseInt(day));
                    }
                }

                return null;
            }

            saveData() {
                localStorage.setItem('officers', JSON.stringify(this.officers));
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        const officerManager = new OfficerManager();

        // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã®è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Service Worker ç™»éŒ² (PWAå¯¾å¿œ)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('[PWA] Service Worker ç™»éŒ²æˆåŠŸ:', registration.scope);
                    
                    // æ›´æ–°ãƒã‚§ãƒƒã‚¯
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('[PWA] Service Worker æ›´æ–°æ¤œå‡º');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('[PWA] æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒåˆ©ç”¨å¯èƒ½ã§ã™');
                                // å¿…è¦ã«å¿œã˜ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ›´æ–°ã‚’é€šçŸ¥
                                if (confirm('ã‚¢ãƒ—ãƒªã®æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ')) {
                                    window.location.reload();
                                }
                            }
                        });
                    });
                    
                } catch (error) {
                    console.error('[PWA] Service Worker ç™»éŒ²å¤±æ•—:', error);
                }
            });
        }

        // PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¿ƒé€²
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            console.log('[PWA] ã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½');
            
            // 3ç§’å¾Œã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¿ƒé€²ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            setTimeout(() => {
                if (confirm('ã“ã®ã‚¢ãƒ—ãƒªã‚’ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã®ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿã‚ˆã‚Šä¾¿åˆ©ã«åˆ©ç”¨ã§ãã¾ã™ã€‚')) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('[PWA] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ‰¿èª');
                        }
                        deferredPrompt = null;
                    });
                }
            }, 3000);
        });

        // ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸæ™‚
        window.addEventListener('appinstalled', (e) => {
            console.log('[PWA] ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸ');
            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ã®é€šçŸ¥
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Ninky', {
                    body: 'ã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚',
                    icon: './ninky-icon-180.png'
                });
            }
        });
    </script>
</body>
</html>
